name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, edited, synchronize, reopened]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          PATTERN="^(feat|fix|docs|refactor|chore|test|ci|release|perf|build|style|revert)\/.+$"

          if ! echo "$BRANCH" | grep -Eq "$PATTERN"; then
            echo ""
            echo "❌ Invalid branch name: \"$BRANCH\""
            echo ""
            echo "Branch names must follow: <type>/<short-description>"
            echo "Types: feat, fix, docs, refactor, chore, test, ci, release, perf, build, style, revert"
            echo ""
            echo "Examples: feat/agent-loop, fix/whatsapp-qr-timeout"
            exit 1
          fi

          echo "✅ Branch name is valid: $BRANCH"

      - name: Validate PR title (becomes the squash commit message)
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}"

          if ! echo "$TITLE" | grep -Eq "$PATTERN"; then
            echo ""
            echo "❌ Invalid PR title: \"$TITLE\""
            echo ""
            echo "The PR title becomes the squash commit message and must follow Conventional Commits:"
            echo ""
            echo "  <type>(<scope>): <description>"
            echo ""
            echo "  Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            echo ""
            echo "  Examples:"
            echo "    feat(agent): add command batching"
            echo "    fix(whatsapp): handle QR code timeout"
            echo "    docs: update README"
            exit 1
          fi

          echo "✅ PR title is valid: $TITLE"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Audit dependencies
        run: npm audit --audit-level=critical

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build
